# ローカル開発環境の構築手順

前提条件：

- Dockerをインストールすること
  - <https://www.docker.com/get-started>
  - Windowsの場合、wsl2が無効である場合は、有効にするよう警告される。そのダイアログに書かれているリンクをクリックして WSLのmsiをダウンロード・インストール。
  - Macの場合は、ダウンロードするファイルが、Intelチップ版とM1チップ版があるので、画面の一番左上のリンゴマークから「このMacについて」を呼び出して確認すること。

<br>

コマンドの表記：

  - [Shell] : `mikawaya_hp/`にて実行
  - [app]   : Dockerの、Webサーバーのシェル（Apache Server）にて実行（Webサーバーのシェルに移動するには、コマンド`docker compose exec {コンテナ名} bash`を使う）

  - また、`docker compose` と `docker-compose` コマンドは全て、docker-compose.ymlファイルが存在するディレクトリに移動して実行すること。

<br>

環境構築の手順：

1. 当リポジトリをクローンする

2. backend/web/admin/.env を作成し、 backend/web/admin/.env.example の内容を全てペーストし、各環境の値に書き換える（ローカルでは基本的にそのままでOK）。

3. 以下のコマンド一覧を実行（mikawaya_hp/ に移動して上から一つずつ実行していけばOK）  
- - `docker compose up -d --build` [Shell]
  - `docker compose exec app bash` [Shell]
  - `composer self-update --2` [app]
  - `composer install` [app]
  - `php artisan storage:link` [app]
  - `chmod 707 -R storage` [app]
  - `php artisan key:generate` [app]
  - `php artisan config:cache` [app]
  - `php artisan migrate:fresh --seed` [app]
  - （以下の子項目で、各コマンドについて解説）

4.  以下のURLでローカル開発環境のクライアント画面が閲覧できる。
- - 管理者ログイン
    - http://localhost/admin/login
  - 一般公開サイト(現在は違う)
    - http://localhost:8080

<br>

## ローカル環境で作業中に使うコマンド一覧

1. ローカルサーバを起動するコマンド(初回以降)
- `docker compose up -d` [Shell]

2. ローカルサーバを終了するコマンド(作業終了後、PCをシャットダウンする前に必ず実行すること)
- `docker compose down` [Shell]

3. Webサーバ(Laravelが実行されているサーバ)のシェルへ移動するコマンド
- `docker compose exec app bash` [Shell]

4. 3 で移動したWebサーバのシェルを終了して、元のシェルに移動するコマンド
- exit

5. Laravelのキャッシュクリアコマンド

- アプリキャッシュのクリア
  - `php artisan cache:clear` [app]

- viewキャッシュのクリア
  - `php artisan view:clear` [app]

- configキャッシュのクリア
  - `php artisan config:cache` [app]

- routeキャッシュのクリア
  - `php artisan route:cache` [app]

<br>

## ローカル環境でのメールの送信について

開発環境では mailhog を利用する。
以下のURLにアクセスすれば mailhog用の受信トレイを表示する事ができる。  

http://localhost:8025/#

<br>

# 以下、環境構築の手順の解説

## `docker compose up -d --build` [Shell]

<br>

Dockerでの環境構築＆実行

<br>

一度、--buildでサーバを構築したら次回から以下のコマンドのみでOK
- `docker compose up -d` [Shell]

<br>

## `docker compose exec app bash` [Shell]

appコンテナに入りShellを操作

<br>

## `composer self-update --2` [app]

<br>

composerのアップグレードコマンド。composerのバージョンを2.x系の最新版にする。

<br>

※以下のコマンドを実行すると最新バージョンを教えてくれる。
- `composer self-update` [app]

<br>

## `composer install` [app]

<br>

composerの実行

<br>

※メモリが足りないなら以下のコマンドを実行  
メモリ不足になりエラーが発生する場合があるのでコマンドでメモリを無制限使用にしている。

- `COMPOSER_MEMORY_LIMIT=-1 $(which composer) install` [app]

<br>

## `php artisan storage:link` [app]

<br>

storage/ リンクの作成

<br>

## `chmod 707 -R storage` [app]

<br>

localhostにアクセスすると、以下のエラーページが表示されることがある。

```
UnexpectedValueException
The stream or file "/work/src/storage/logs/laravel.log" could not be opened in append mode: Failed to open stream: Permission denied
http://localhost/
```

このエラーは、phpを実行するアプリケーション(今回の場合はnginxサーバ)に、storage/内のファイルの書き込み権限がないことで、storage/内にlogを記録できないことで発生するもの。

<br>

これを解決するには、このコマンドを実行する。  
このコマンドで、nginxアプリケーションに対してstorage/以下のファイルの全権限を与えることができる。

<br>

## `php artisan key:generate` [app]

<br>

encryption key の生成。  
artisan コマンドで encryption key を設定する。  
(参考：https://qiita.com/ponsuke0531/items/197c76fcb9300d7c5f36)。

<br>

## `php artisan migrate:fresh --seed` [app]

<br>

DBの構築とテストデータの作成  
※本番環境では実行しないでください。DBがテストデータで再作成されるので登録データが消えてしまいます。

<br>

## `php artisan storage:link` [app]

ローカル開発環境構築-11. storage用シンボリックリンクを張る  
シンボリックリンクを作成すると、storage/内のファイルを公開する事ができるようになる。
